@{
    ViewData["Title"] = "Generar App";
}


@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">
        @TempData["Error"]
    </div>
}
<div class="position-relative overflow-hidden" style="min-height: 100vh; background: linear-gradient(135deg, #f0f4ff 0%, #e2e6fa 100%); display: flex; align-items: center; justify-content: center;">

    <div class="position-absolute top-0 end-0 translate-middle-y bg-primary opacity-10 rounded-circle" style="width: 600px; height: 600px; filter: blur(120px); margin-right: -200px;"></div>
    <div class="position-absolute bottom-0 start-0 translate-middle-x bg-info opacity-10 rounded-circle" style="width: 500px; height: 500px; filter: blur(100px); margin-left: -100px;"></div>

    <div class="container position-relative z-2">
        <div class="row justify-content-center">
            <div class="col-lg-5 col-md-7">

                <div class="card shadow-2xl rounded-4 glass-card hover-lift-more overflow-hidden h-100 border-0" style="background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px);">

                    <div class="card-body p-5">

                        <div class="text-center mb-4 mt-2">
                            <div class="d-flex justify-content-center mb-3">
                                <div class="floating-animation position-relative" style="width: 180px; height: 180px;">

                                    <div class="position-absolute top-50 start-50 translate-middle bg-primary opacity-20 rounded-circle" style="width: 140px; height: 140px; filter: blur(30px);"></div>

                                    <lottie-player src="https://assets2.lottiefiles.com/packages/lf20_w51pcehl.json"
                                                   background="transparent"
                                                   speed="1"
                                                   style="width: 100%; height: 100%; position: relative; z-index: 2;"
                                                   loop
                                                   autoplay>
                                    </lottie-player>
                                </div>
                            </div>

                            <h2 class="fw-bolder mb-2 text-gradient-dark">Configura tu App</h2>
                            <p class="text-muted small">Selecciona el origen de datos para iniciar.</p>
                        </div>

                        <form id="generarForm" method="post" action="@Url.Action("GenerarApk", "Generador")">
                            <div class="mb-4">
                                <label for="selectedDb" class="form-label fw-bold text-secondary small letter-spacing-1 mb-2">
                                    <i class="fa fa-database text-primary me-2"></i>Base de Datos Azure
                                </label>

                                <div class="input-group input-group-lg shadow-sm rounded-3 overflow-hidden border-0 bg-light custom-input-focus">


                                    <select name="selectedDb" id="dbSelector" class="form-select border-0 bg-transparent py-3 fw-medium text-dark" required>
                                        <option value="">-- Selecciona base de datos --</option>
                                    </select>

                                </div>

                                <div class="text-center mt-3">
                                    <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-10 rounded-pill px-3 py-2 fw-medium">
                                        <i class="fa fa-lock me-1"></i> Conexión Encriptada
                                    </span>
                                </div>
                            </div>

                            <div class="d-grid mt-4">
                                <button type="submit" id="btnGenerar" class="btn btn-primary btn-lg py-3 rounded-pill fw-bold shadow-glow hover-scale d-flex align-items-center justify-content-center text-white"
                                        style="background: linear-gradient(90deg, #2563eb 0%, #06b6d4 100%); border: none;">
                                    <span class="me-2 letter-spacing-1">GENERAR PROYECTO</span>
                                    <i class="fa fa-arrow-right ms-2 moving-icon"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <p class="text-center text-muted mt-4 small fw-medium opacity-75">
                    &copy; 2026 Fabrica de Software. Motor v2.0
                </p>

            </div>

            <!-- Columna Derecha: Panel de Progreso (Inicialmente Oculto) -->
            <div class="col-lg-5 col-md-6 d-none fade-in-right" id="progressColumn">
                <div class="card shadow-2xl rounded-4 glass-card h-100 border-0" style="background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px);">
                    <div class="card-body p-4">
                        <div class="text-center mb-4">
                            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
                            <h4 class="fw-bold text-dark">Generando...</h4>
                            <p class="text-muted small">No cierres esta ventana</p>
                        </div>

                        <ul class="list-unstyled" id="processSteps">
                            <li class="d-flex align-items-center mb-4 step-item" data-step="1">
                                <div class="icon-box me-3"><i class="far fa-circle text-secondary fa-lg step-icon"></i></div>
                                <div>
                                    <h6 class="mb-0 fw-bold step-text text-muted">Validando configuración</h6>
                                    <small class="text-muted step-desc">Verificando parámetros...</small>
                                </div>
                            </li>
                            <li class="d-flex align-items-center mb-4 step-item" data-step="2">
                                <div class="icon-box me-3"><i class="far fa-circle text-secondary fa-lg step-icon"></i></div>
                                <div>
                                    <h6 class="mb-0 fw-bold step-text text-muted">Esquema de Base de Datos</h6>
                                    <small class="text-muted step-desc">Extrayendo estructura...</small>
                                </div>
                            </li>
                            <li class="d-flex align-items-center mb-4 step-item" data-step="3">
                                <div class="icon-box me-3"><i class="far fa-circle text-secondary fa-lg step-icon"></i></div>
                                <div>
                                    <h6 class="mb-0 fw-bold step-text text-muted">Limpieza de Entorno</h6>
                                    <small class="text-muted step-desc">Preparando Flutter...</small>
                                </div>
                            </li>
                            <li class="d-flex align-items-center mb-4 step-item" data-step="4">
                                <div class="icon-box me-3"><i class="far fa-circle text-secondary fa-lg step-icon"></i></div>
                                <div>
                                    <h6 class="mb-0 fw-bold step-text text-muted">Compilando APK</h6>
                                    <small class="text-muted step-desc">Construyendo release (Lento)...</small>
                                </div>
                                <div class="spinner-border spinner-border-sm text-primary ms-auto d-none step-spinner" role="status"></div>
                            </li>
                            <li class="d-flex align-items-center mb-4 step-item" data-step="5">
                                <div class="icon-box me-3"><i class="far fa-circle text-secondary fa-lg step-icon"></i></div>
                                <div>
                                    <h6 class="mb-0 fw-bold step-text text-muted">Empaquetando Código</h6>
                                    <small class="text-muted step-desc">Generando ZIP...</small>
                                </div>
                            </li>
                            <li class="d-flex align-items-center step-item" data-step="6">
                                <div class="icon-box me-3"><i class="far fa-circle text-secondary fa-lg step-icon"></i></div>
                                <div>
                                    <h6 class="mb-0 fw-bold step-text text-muted">Finalizando</h6>
                                    <small class="text-muted step-desc">Listo para descargar</small>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    .step-text { transition: color 0.3s ease; }
    .step-item.active .step-text { color: #0d6efd !important; }
    .step-item.active .step-icon { color: #0d6efd !important; }
    .step-item.completed .step-text { color: #198754 !important; }
    .step-item.completed .step-icon { color: #198754 !important; }
    .step-item.completed .step-desc { color: #198754 !important; opacity: 0.8; }
    
    .fade-in-right { animation: fadeInRight 0.5s ease-out forwards; }
    @@keyframes fadeInRight {
        from { opacity: 0; transform: translateX(20px); }
        to { opacity: 1; transform: translateX(0); }
    }
</style>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dbSelector = document.getElementById('dbSelector');
            
            // Cargar bases de datos asíncronamente
            fetch('@Url.Action("GetDatabases", "Generador")')
                .then(response => response.json())
                .then(data => {
                    dbSelector.innerHTML = '<option value="">-- Selecciona base de datos --</option>';
                    if (data.success) {
                        data.databases.forEach(db => {
                            const option = document.createElement('option');
                            option.value = db;
                            option.textContent = db;
                            dbSelector.appendChild(option);
                        });
                    } else {
                        dbSelector.innerHTML = '<option value="">Error al cargar bases de datos</option>';
                    }
                })
                .catch(error => {
                    console.error('Error cargando bases de datos:', error);
                    dbSelector.innerHTML = '<option value="">Error de conexión</option>';
                });
        });

        document.getElementById('generarForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const btnGenerar = document.getElementById('btnGenerar');
            const progressColumn = document.getElementById('progressColumn');
            
            // UI Changes
            btnGenerar.disabled = true;
            btnGenerar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Procesando...';
            
            // Mostrar columna derecha
            progressColumn.classList.remove('d-none');
            
            const updateStep = (stepIndex, status) => {
                const steps = document.querySelectorAll('.step-item');
                const step = steps[stepIndex];
                const icon = step.querySelector('.step-icon');
                const text = step.querySelector('.step-text');
                const spinner = step.querySelector('.step-spinner');

                if (status === 'active') {
                    step.classList.add('active');
                    text.classList.remove('text-muted');
                    icon.className = 'fas fa-spinner fa-spin text-primary fa-lg step-icon';
                    if(spinner) spinner.classList.remove('d-none');
                } else if (status === 'completed') {
                    step.classList.remove('active');
                    step.classList.add('completed');
                    icon.className = 'fas fa-check-circle text-success fa-lg step-icon';
                    if(spinner) spinner.classList.add('d-none');
                }
            };

            // Simular progreso
            updateStep(0, 'active'); // Validando

            setTimeout(() => { updateStep(0, 'completed'); updateStep(1, 'active'); }, 1500);
            setTimeout(() => { updateStep(1, 'completed'); updateStep(2, 'active'); }, 3000);
            setTimeout(() => { updateStep(2, 'completed'); updateStep(3, 'active'); }, 5000); // Entra a compilar

            fetch('@Url.Action("GenerarApk", "Generador")', {
                method: 'POST',
                body: formData,
                redirect: 'follow'
            })
            .then(response => {
                updateStep(3, 'completed'); // Fin compilar
                updateStep(4, 'active'); // Empaquetando
                
                setTimeout(() => {
                    updateStep(4, 'completed');
                    updateStep(5, 'active'); // Finalizando
                }, 800);

                setTimeout(() => {
                    updateStep(5, 'completed');
                    
                    if (response.redirected) {
                        window.location.href = response.url;
                    } else if (response.ok) {
                        window.location.href = '@Url.Action("Descargar", "Generador")';
                    } else {
                        throw new Error('Error en la generación');
                    }
                }, 1500);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al generar el APK. Por favor intenta nuevamente.');
                btnGenerar.disabled = false;
                btnGenerar.innerHTML = '<span class="me-2 letter-spacing-1">GENERAR PROYECTO</span><i class="fa fa-arrow-right ms-2 moving-icon"></i>';
            });
        });
    </script>
}