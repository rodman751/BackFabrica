@{
    ViewData["Title"] = "Generar App";
    var databases = ViewBag.Databases as IEnumerable<string>;
}


@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">
        @TempData["Error"]
    </div>
}
<div class="position-relative overflow-hidden" style="min-height: 100vh; background: linear-gradient(135deg, #f0f4ff 0%, #e2e6fa 100%); display: flex; align-items: center; justify-content: center;">

    <div class="position-absolute top-0 end-0 translate-middle-y bg-primary opacity-10 rounded-circle" style="width: 600px; height: 600px; filter: blur(120px); margin-right: -200px;"></div>
    <div class="position-absolute bottom-0 start-0 translate-middle-x bg-info opacity-10 rounded-circle" style="width: 500px; height: 500px; filter: blur(100px); margin-left: -100px;"></div>

    <div class="container position-relative z-2">
        <div class="row justify-content-center">
            <div class="col-lg-5 col-md-7">

                <div class="card shadow-2xl rounded-4 glass-card hover-lift-more overflow-hidden">

                    <div class="card-body p-5">

                        <div class="text-center mb-4 mt-2">
                            <div class="d-flex justify-content-center mb-3">
                                <div class="floating-animation position-relative" style="width: 180px; height: 180px;">

                                    <div class="position-absolute top-50 start-50 translate-middle bg-primary opacity-20 rounded-circle" style="width: 140px; height: 140px; filter: blur(30px);"></div>

                                    <lottie-player src="https://assets2.lottiefiles.com/packages/lf20_w51pcehl.json"
                                                   background="transparent"
                                                   speed="1"
                                                   style="width: 100%; height: 100%; position: relative; z-index: 2;"
                                                   loop
                                                   autoplay>
                                    </lottie-player>
                                </div>
                            </div>

                            <h2 class="fw-bolder mb-2 text-gradient-dark">Configura tu App</h2>
                            <p class="text-muted small">Selecciona el origen de datos para iniciar.</p>
                        </div>

                        <form id="generarForm" method="post" action="@Url.Action("GenerarApk", "Generador")">
                            <div class="mb-4">
                                <label for="selectedDb" class="form-label fw-bold text-secondary small letter-spacing-1 mb-2">
                                    <i class="fa fa-database text-primary me-2"></i>Base de Datos Azure
                                </label>

                                <div class="input-group input-group-lg shadow-sm rounded-3 overflow-hidden border-0 bg-light custom-input-focus">
                                    
                                  
                                    <select name="selectedDb" id="dbSelector" class="form-select border-0 bg-transparent py-3 fw-medium text-dark" required >
                                        <option value="">-- Seleccione una Base de Datos --</option>
                                        @if (databases != null)
                                        {
                                            foreach (var db in databases)
                                            {
                                                <option value="@db">@db</option>
                                            }
                                        }
                                    </select>
                                   
                                </div>

                                <div class="text-center mt-3">
                                    <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-10 rounded-pill px-3 py-2 fw-medium">
                                        <i class="fa fa-lock me-1"></i> Conexión Encriptada
                                    </span>
                                </div>
                            </div>

                            <div class="d-grid mt-4">
                                <button type="submit" class="btn btn-primary btn-lg py-3 rounded-pill fw-bold shadow-glow hover-scale d-flex align-items-center justify-content-center text-white"
                                        style="background: linear-gradient(90deg, #2563eb 0%, #06b6d4 100%); border: none;">
                                    <span class="me-2 letter-spacing-1">GENERAR PROYECTO</span>
                                    <i class="fa fa-arrow-right ms-2 moving-icon"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <p class="text-center text-muted mt-4 small fw-medium opacity-75">
                    &copy; 2026 Fabrica de Software. Motor v2.0
                </p>

            </div>
        </div>
    </div>
</div>

<div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; text-align:center; padding-top:20%;">
    <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Cargando...</span>
    </div>
    <h3 class="text-white mt-3">Compilando App con Flutter...</h3>
    <p class="text-white">Esto puede tardar unos minutos. Por favor no cierres la ventana.</p>
</div>

@section Scripts {
    <script>
        document.getElementById('generarForm').addEventListener('submit', function(e) {
            e.preventDefault(); // Prevenir envío normal

            const formData = new FormData(this);
            const loadingOverlay = document.getElementById('loadingOverlay');
            const selectedDb = document.getElementById('dbSelector').value; // ← Obtener el valor seleccionado

            // Mostrar spinner
            loadingOverlay.style.display = 'block';

            // Hacer petición AJAX
            fetch('@Url.Action("GenerarApk", "Generador")', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la generación del APK');
                }
                return response.blob(); // Obtener el archivo como blob
            })
            .then(blob => {
                // Crear enlace de descarga
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                    a.download = `App_${selectedDb}_${new Date().getTime()}.apk`; // ← Usar la variable correcta
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                // CERRAR SPINNER
                loadingOverlay.style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al generar el APK. Por favor intenta nuevamente.');

                // CERRAR SPINNER en caso de error
                loadingOverlay.style.display = 'none';
            });
        });
    </script>
}